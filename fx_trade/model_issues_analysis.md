# モデル問題分析レポート

## 🚨 重大な問題の判明

### 問題の概要
Focal Loss + 時系列CVで学習したモデルが、バックテストで全く取引シグナルを出さない重大な問題が判明しました。

### 具体的な問題

#### 1. 回帰モデルの問題
- **予測範囲**: 0.0038～0.0046（0.4%程度の極小範囲）
- **実際の株価変動**: 通常±1-3%の日次変動
- **問題**: モデルが現実的な価格変動を予測できていない

#### 2. 分類モデルの問題
- **方向予測**: 100%「横ばい」を予測
- **天底予測**: 100%「通常」を予測
- **問題**: モデルが多様性を失い、単一クラスに偏っている

#### 3. 取引戦略の問題
- **取引回数**: 0回（柔軟な戦略でも）
- **問題**: 予測が現実的でないため、取引条件を満たさない

## 🔍 根本原因の分析

### 1. データ前処理の問題
```python
# 現在の設定
price_change_threshold: 0.04  # 4%以上の変動を有意とする
threshold_return: 0.03        # 3%以上のリターンを買いシグナルとする
```

**問題**: 閾値が厳しすぎて、学習データの多様性が失われている

### 2. クラス不均衡の悪化
- **方向予測**: 横ばいが66.5%（1602/2463）
- **天底検出**: 通常が85%以上
- **問題**: クラスウェイトが極端になりすぎて、モデルが保守的になった

### 3. 特徴量の正規化問題
- 回帰予測の範囲が極小（0.4%）
- 実際の株価変動は通常±1-3%
- **問題**: 特徴量のスケールが不適切

### 4. モデルアーキテクチャの問題
- LSTMの出力が制限されている可能性
- 活性化関数や出力層の設定に問題

## 💡 解決策の提案

### 1. データ前処理の改善
```python
# より現実的な閾値設定
price_change_threshold: 0.015  # 1.5%に緩和
threshold_return: 0.01         # 1%に緩和
window: 3                      # 天底検出の窓を小さく
```

### 2. クラス不均衡対策の見直し
```python
# より穏やかなクラスウェイト
class_weights = {
    0: 2.0,  # 下降
    1: 1.0,  # 横ばい（基準）
    2: 2.0   # 上昇
}
```

### 3. 特徴量エンジニアリングの改善
- 価格変動率の正規化方法を見直し
- より多様なテクニカル指標の追加
- 市場環境に応じた特徴量の動的調整

### 4. モデルアーキテクチャの改善
- 出力層の活性化関数を調整
- ドロップアウト率の見直し
- より深いネットワークの検討

### 5. 損失関数の見直し
- Focal Lossのパラメータ調整
- 回帰と分類の損失バランス調整
- カスタム損失関数の実装

## 🎯 推奨する次のステップ

### Phase 1: データ前処理の修正
1. 閾値を現実的な値に調整
2. クラス分布の再確認
3. 特徴量のスケーリング見直し

### Phase 2: モデル再学習
1. 修正されたデータで再学習
2. ハイパーパラメータの調整
3. 複数のアーキテクチャの比較

### Phase 3: バックテスト検証
1. 現実的な取引戦略の実装
2. リスク管理の追加
3. パフォーマンス指標の改善

## 📊 期待される改善効果

### 短期的改善
- 取引回数の増加（0回 → 10-50回）
- 予測の多様性向上
- 現実的なリターン予測

### 中期的改善
- 勝率の向上（50%以上）
- リスク調整後リターンの改善
- ドローダウンの抑制

### 長期的改善
- Buy & Holdを上回るパフォーマンス
- 安定した収益性の確立
- 実用可能なトレーディングシステム

## 🔧 実装優先度

### 高優先度（即座に実装）
1. データ前処理の閾値調整
2. クラスウェイトの見直し
3. 特徴量スケーリングの修正

### 中優先度（1-2週間以内）
1. モデルアーキテクチャの改善
2. 損失関数の調整
3. ハイパーパラメータの最適化

### 低優先度（長期計画）
1. 新しい特徴量の追加
2. アンサンブル手法の導入
3. リアルタイム取引システムの構築

---

**結論**: 現在のモデルは根本的な問題を抱えており、データ前処理から見直す必要があります。段階的な改善により、実用可能なトレーディングシステムの構築が期待できます。
